---
title: "Tornado Analysis"
author: "Owen Widdis"
date: "2025-12-01"
output: html_document
---

# R Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
install.packages("viridis")
library(tidyverse)
library(lubridate)
library(dplyr)
library(ggplot2)
library(quantmod)
library(scales)
library(ggplot2)
library(viridis)  # for nice color scales

options(scipen = 999)

```

# Load data

```{r}
# Load CSV
tornado_df <- read_csv("C:/Users/walke/Documents/umich/courses/SI544/final_proj/tornado_analysis/csv_files/merged_files.csv")

# Convert numeric columns
numeric_cols <- c(
  "TOR_LENGTH", "TOR_WIDTH",
  "DEATHS_DIRECT", "INJURIES_DIRECT",
  "DAMAGE_PROPERTY_NUM", "DAMAGE_CROPS_NUM"
)

tornado_df <- tornado_df %>%
  mutate(across(all_of(numeric_cols), ~as.numeric(.)))

# Convert dates + create DATE column for joining
tornado_df <- tornado_df %>%
  mutate(
    BEGIN_DATE = mdy(BEGIN_DATE),
    END_DATE   = mdy(END_DATE),
    DATE       = as.Date(BEGIN_DATE),
    YEAR       = year(BEGIN_DATE)
  )

# rm columns
tornado_df <- tornado_df %>%
  select(
    -EVENT_ID,
    -CZ_NAME_STR,
    -EVENT_TYPE
  )
```

```{r}

# Download CPI from FRED (monthly)
getSymbols("CPIAUCSL", src = "FRED")

# Convert to tibble
cpi_df <- CPIAUCSL %>%
  data.frame(date = index(.)) %>%
  as_tibble() %>%
  rename(CPIAUCSL = CPIAUCSL)

# 2025 CPI target
target_cpi <- 324.368

# Inflation adjustment factor
cpi_df <- cpi_df %>%
  mutate(adj_factor = target_cpi / CPIAUCSL)

tornado_df <- tornado_df %>%
  mutate(
    DATE = as.Date(BEGIN_DATE),
    DATE_MONTH = floor_date(DATE, unit = "month")
  )

# Left join by DATE (tornado) and date (CPI)
tornado_df <- tornado_df %>%
  left_join(cpi_df, by = c("DATE_MONTH" = "date"))

tornado_df <- tornado_df %>%
  mutate(
    DAMAGE_PROPERTY_2025 = DAMAGE_PROPERTY_NUM * adj_factor,
    DAMAGE_CROPS_2025    = DAMAGE_CROPS_NUM * adj_factor,
    DAMAGE_PROPERTY_2025_DOL = dollar(DAMAGE_PROPERTY_2025),
    DAMAGE_CROPS_2025_DOL    = dollar(DAMAGE_CROPS_2025)
  )

# Clean tornado dataset with uppercase column names
tornado_clean <- tornado_df %>%
  # Keep only relevant columns (uppercase)
  select(
    DATE, YEAR,
    BEGIN_DATE, END_DATE,
    BEGIN_LAT, BEGIN_LON,
    END_LAT, END_LON,
    TOR_LENGTH, TOR_WIDTH,
    DEATHS_DIRECT, INJURIES_DIRECT,
    DAMAGE_PROPERTY_NUM, DAMAGE_CROPS_NUM,
    DAMAGE_PROPERTY_2025, DAMAGE_CROPS_2025
  ) %>%
  # Rename columns to uppercase + more readable
  rename(
    START_DATE = BEGIN_DATE,
    END_DATE   = END_DATE,
    START_LAT  = BEGIN_LAT,
    START_LON  = BEGIN_LON,
    END_LAT    = END_LAT,
    END_LON    = END_LON,
    TORNADO_LENGTH = TOR_LENGTH,
    TORNADO_WIDTH  = TOR_WIDTH,
    DEATHS  = DEATHS_DIRECT,
    INJURIES = INJURIES_DIRECT,
    DAMAGE_PROPERTY = DAMAGE_PROPERTY_NUM,
    DAMAGE_CROPS    = DAMAGE_CROPS_NUM,
    DAMAGE_PROPERTY_2025_USD = DAMAGE_PROPERTY_2025,
    DAMAGE_CROPS_2025_USD    = DAMAGE_CROPS_2025
  ) %>%
  # Add formatted dollar versions for display
  mutate(
    DAMAGE_PROPERTY_2025_DOL = dollar(DAMAGE_PROPERTY_2025_USD),
    DAMAGE_CROPS_2025_DOL    = dollar(DAMAGE_CROPS_2025_USD)
  ) %>%
  # Sort by DATE ascending
  arrange(DATE)

# Preview
glimpse(tornado_clean)

```

# Tests
```{r}

df_corr_price_intensity <- tornado_clean %>%
  select(
    DAMAGE_PROPERTY_2025_USD,
    DAMAGE_CROPS_2025_USD,
    TORNADO_LENGTH,
    TORNADO_WIDTH
  ) %>%
  drop_na()

summary(df_corr_price_intensity)


cor.test(
  df_corr_price_intensity$DAMAGE_PROPERTY_2025_USD,
  df_corr_price_intensity$TORNADO_LENGTH,
  method = "spearman"
)

cor.test(
  df_corr_price_intensity$DAMAGE_PROPERTY_2025_USD,
  df_corr_price_intensity$TORNADO_WIDTH,
  method = "spearman"
)

cor(
  df_corr_price_intensity %>%
    select(
      DAMAGE_PROPERTY_2025_USD,
      TORNADO_LENGTH,
      TORNADO_WIDTH
    ),
  method = "spearman",
  use = "complete.obs"
)

ggplot(df_corr_price_intensity,
       aes(TORNADO_WIDTH, DAMAGE_PROPERTY_2025_USD)) +
  geom_point(alpha = 0.3) +
  scale_y_log10() +
  labs(
    title = "Inflation-Adjusted Property Damage vs Tornado Width",
    x = "Tornado Width",
    y = "Property Damage (2025 USD, log scale)"
  )


```



```{r}

# regression
df_reg <- tornado_clean %>%
  select(
    DAMAGE_PROPERTY_2025_USD,
    TORNADO_LENGTH,
    TORNADO_WIDTH,
    YEAR
  ) %>%
  filter(
    !is.na(DAMAGE_PROPERTY_2025_USD),
    DAMAGE_PROPERTY_2025_USD > 0,
    !is.na(TORNADO_LENGTH),
    !is.na(TORNADO_WIDTH)
  ) %>%
  mutate(
    LOG_DAMAGE = log(DAMAGE_PROPERTY_2025_USD),
    LENGTH_Z = as.numeric(scale(TORNADO_LENGTH)),
    WIDTH_Z  = as.numeric(scale(TORNADO_WIDTH))
  )
model_1 <- lm(
  LOG_DAMAGE ~ LENGTH_Z + WIDTH_Z,
  data = df_reg
)

summary(model_1)

# Make the combined plot
ggplot(df_reg, aes(x = TORNADO_LENGTH, y = LOG_DAMAGE, color = TORNADO_WIDTH)) +
  geom_point(alpha = 0.4) +                             # scatter points
  geom_smooth(method = "lm", se = TRUE, color = "black") +  # regression line
  scale_color_viridis(option = "plasma", trans = "log", direction = -1) +  # log color scale for width
  labs(
    title = "Inflation-Adjusted Property Damage by Tornado Length and Width",
    subtitle = "Point color indicates tornado width; line shows regression trend",
    x = "Tornado Length (miles)",
    y = "Log(Property Damage in 2025 USD)",
    color = "Tornado Width (yards)"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold"),
    plot.subtitle = element_text(face = "italic"),
    legend.position = "right" 
  ) + xlim(0, 50)



```